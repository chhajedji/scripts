#!/bin/bash

# Pre-requisites: `speedtest'

# Usage:
# `netspeed CYCLES[number of tests]' [anything for upload][optional].

CYCLES=$1
# Default is 5 cycles
[ -n "$CYCLES" ] || CYCLES=5

rm $HOME/upspeed 2>/dev/null

echo $(date) > $HOME/downspeed
echo '' >> $HOME/downspeed

for((i=0;i<$CYCLES;i++));do
    (command -v speedtest >/dev/null && speedtest --no-upload |grep ^Download |tee -a $HOME/downspeed)
done

# Update number of cycles based on results. This might be less than or equal to
# `CYCLES' defined earlier.
ROUNDS=$(cat $HOME/downspeed | grep "^Download: [0-9.]\{1,4\}" | wc -l)

# Calculating average download speed.
echo "" >> $HOME/downspeed
echo -n "Average download speed in Mbps for $ROUNDS cycle is " >> $HOME/downspeed
echo "scale=2; (($(cat $HOME/downspeed | sed 's/.* \([0-9]*\.[0-9]*\) .*/\1/p' -n | paste -sd '+'))/$ROUNDS)" | bc >> $HOME/downspeed

notify-send "Download speed results.

$(cat $HOME/downspeed)"



# Follow same procedure used above for upload speed also.


# Give any argument after number of cycles to log upload speed.
if [ $2 ]; then
    echo $(date) > $HOME/upspeed
    echo '' >> $HOME/upspeed
    for((i=0;i<$CYCLES;i++));do
        command -v speedtest >/dev/null && speedtest --no-download |grep ^Upload |tee -a $HOME/upspeed
    done

# Update number of cycles based on results. This might be less than or equal to
# `CYCLES' defined earlier.
    ROUNDS=$(cat $HOME/upspeed | grep "^Upload: [0-9.]\{1,4\}" | wc -l)

    echo "" >> $HOME/upspeed
    echo -n "Average upload speed in Mbps for $ROUNDS cycle is " >> $HOME/upspeed
    echo "scale=2; (($(cat $HOME/upspeed | sed 's/.* \([0-9]*\.[0-9]*\) .*/\1/p' -n | paste -sd '+'))/$ROUNDS)" | bc >> $HOME/upspeed
    notify-send "Upload speed results.

    $(cat $HOME/upspeed)"

fi
